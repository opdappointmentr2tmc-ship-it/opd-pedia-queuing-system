<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pediatric Clinic Queueing System</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:Segoe UI,Tahoma,sans-serif;}
body { background:#f0f2f5; padding:20px; color:#333; min-height:100vh; }

#headerBar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
#settingsButton { padding:14px; font-size:18px; border-radius:10px; background:#4facfe; color:white; font-weight:700; border:none; cursor:pointer; width:150px; text-align:center; }

#tablesContainer { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }
#tables { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; flex:1; }

.prefix-dropdown { width:100%; padding:10px; font-size:18px; border-radius:8px; margin-top:10px; }

.table-box { background:white; padding:25px; border-radius:18px; box-shadow:0 8px 25px rgba(0,0,0,0.1); text-align:center; transition: all 0.3s ease; }
.table-box.pulse { animation:pulseRecall 1s ease-in-out; }
@keyframes pulseRecall {0% { box-shadow:0 0 20px rgba(23,162,184,0.8); transform:scale(1); }50%{ box-shadow:0 0 40px rgba(23,162,184,0.9); transform:scale(1.05);}100%{ box-shadow:0 0 20px rgba(23,162,184,0.8); transform:scale(1);} }
.vital-full { animation:vitalFullPulse 0.8s ease-in-out; color:red !important; font-weight:900;}
@keyframes vitalFullPulse{0%{transform:scale(1);}50%{transform:scale(1.15);}100%{transform:scale(1);}}

.table-box.highlight { animation: highlightPulse 1s ease-in-out; }
@keyframes highlightPulse {
  0% { box-shadow: 0 0 20px rgba(40,167,69,0.8); transform: scale(1); }
  50% { box-shadow: 0 0 40px rgba(40,167,69,0.9); transform: scale(1.03); }
  100% { box-shadow: 0 0 20px rgba(40,167,69,0.8); transform: scale(1); }
}

button { padding:14px; margin-top:10px; width:100%; border:none; border-radius:10px; font-size:18px; color:white; font-weight:700; cursor:pointer; }
.next-btn { background:#007bff; } .done-btn { background:#6c757d; } .owc-btn { background:#ffc107; color:#333; } .recall-btn { background:#17a2b8; }

.queue-number { font-size:80px; font-weight:900; background:#e0e4e8; padding:20px; border-radius:15px; margin:20px 0; }

#vitalAndDone { display:flex; gap:20px; margin-top:30px; flex-wrap:wrap; }
#vitalSignList, #doneNumbersList { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; }

#vitalSignList .done-number { background:#d0d4d8; padding:10px; height:60px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; font-size:22px; font-weight:900; }
#doneNumbersList .done-number { background:#d0d4d8; padding:10px; height:50px; border-radius:6px; display:flex; justify-content:center; align-items:center; font-size:22px; font-weight:900; }

#owcContainer { width:280px; }
#owcList { max-height:500px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
.owc-item { background:#ececec; padding:12px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; font-weight:900; font-size:22px; }
.restore-btn { padding:5px 8px; border-radius:6px; border:none; cursor:pointer; background:#28a745; color:white; }

#modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); display:none; justify-content:center; align-items:center; }
#modalBox { background:white; padding:30px; border-radius:20px; width:330px; text-align:center; }
</style>
</head>
<body>

<div id="headerBar">
  <h1>Pediatric Clinic Queueing System</h1>
  <button id="settingsButton" onclick="showSettings()">Settings ⚙️</button>
</div>

<div id="tablesContainer">
  <div id="tables"></div>
  <div id="owcContainer">
    <h2>OWC LIST</h2>
    <div id="owcList"></div>
  </div>
</div>

<div id="vitalAndDone">
  <div style="flex:1;">
    <h2>Vital Sign List (Max 10)</h2>
    <div id="vitalSignList"></div>
  </div>
  <div style="flex:1;">
    <h2>Done Numbers (Table 1)</h2>
    <div id="doneNumbersList"></div>
  </div>
</div>

<div id="modalOverlay">
  <div id="modalBox">
    <h2>Settings</h2>
    <label>Custom Prefixes (comma separated)</label>
    <input id="prefixInput" type="text" style="width:100%; padding:8px; margin-top:8px;">
    <button onclick="savePrefix()" style="background:#007bff;">Save Prefixes</button>
    <button onclick="resetQueues()" style="background:#dc3545;">Reset Queues & OWC</button>
    <button onclick="closeSettings()" style="background:#28a745;">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlGQraZ7m_cdzL2bCxWOb1A165gTwVRKQ",
  authDomain: "r2tmc-opd-pedia-qs.firebaseapp.com",
  projectId: "r2tmc-opd-pedia-qs",
  storageBucket: "r2tmc-opd-pedia-qs.appspot.com",
  messagingSenderId: "467931438036",
  appId: "1:467931438036:web:7a15d05ff4a159116e9441",
  measurementId: "G-KKYGFRSTWB",
  databaseURL: "https://r2tmc-opd-pedia-qs-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const TOTAL_TABLES = 5;
let prefixes = [];
let seriesByPrefix = {};
let table1DoneNumbers = [];
let usedNumbers = new Set();
let tableState = {};
for (let i=1;i<=TOTAL_TABLES;i++) tableState[i]=true;

/* -------------------- Highlight Table -------------------- */
function highlightTable(i){
  const tableBox = document.getElementById(`tableBox${i}`);
  tableBox.classList.add("highlight");
  setTimeout(()=>tableBox.classList.remove("highlight"),1000);
}

/* -------------------- Render Tables -------------------- */
function renderTables(){
  let html="";
  for(let i=1;i<=TOTAL_TABLES;i++){
    html+=`
      <div class="table-box" id="tableBox${i}">
        <h2>Table ${i}</h2>
        <select id="prefixSelect${i}" class="prefix-dropdown"></select>
        <div id="num${i}" class="queue-number">0</div>
        ${i!==1?`<button id="doneBtn${i}" class="done-btn" onclick="doneQueue(${i})">Done</button>`:""}
        <button id="nextBtn${i}" class="next-btn" onclick="nextQueue(${i})" ${i!==1?"disabled":""}>Next</button>
        ${i!==1?`<button class="owc-btn" onclick="owcQueue(${i})">OWC</button>`:""}
        <button class="recall-btn" onclick="recallQueue(${i})">Recall</button>
      </div>
    `;
  }
  document.getElementById("tables").innerHTML=html;
}
renderTables();

/* -------------------- Load Persistent Table Numbers -------------------- */
for (let i = 1; i <= TOTAL_TABLES; i++) {
  onValue(ref(db, `tableNumbers/table${i}`), snap => {
    if (snap.exists()) {
      const val = snap.val();
      const numEl = document.getElementById(`num${i}`);
      if (numEl) {
        numEl.textContent = val;
        if (i !== 1 && val !== "0" && val !== "-") {
          document.getElementById(`nextBtn${i}`).disabled = true;
          usedNumbers.add(val);
          table1DoneNumbers = table1DoneNumbers.filter(n => n !== val);
        }
        if (i === 1 && val !== "0" && val !== "-") {
          if (!document.getElementById(`vital-${val}`)) renderVitalSignList(val);
        }
      }
    }
  });
}

/* -------------------- Prefix Handling -------------------- */
onValue(ref(db,"settings/prefixes"), snap=>{
  prefixes = snap.exists()?snap.val():[];
  document.getElementById("prefixInput").value=prefixes.join(",");
  updatePrefixDropdowns();
});
onValue(ref(db,"prefixSeries"), snap=>{
  seriesByPrefix = snap.exists()?snap.val():{};
});
function updatePrefixDropdowns(){
  for(let i=1;i<=TOTAL_TABLES;i++){
    const sel=document.getElementById("prefixSelect"+i); 
    sel.innerHTML="";
    prefixes.forEach(p=>{
      const o=document.createElement("option"); 
      o.value=p; 
      o.textContent=p; 
      sel.appendChild(o);
    });
  }
}

/* -------------------- Next Queue -------------------- */
function format(prefix,num){ return `${prefix}-${String(num).padStart(3,"0")}`; }
function saveTableNumber(i,num){ set(ref(db,"tableNumbers/table"+i),num); }
function getNextAvailableNumber(prefix){ return table1DoneNumbers.find(n=>n.startsWith(prefix)&&!usedNumbers.has(n))||null; }

window.nextQueue=function(i){
  const prefix=document.getElementById("prefixSelect"+i).value; if(!prefix) return;

  if(i===1){
    const list=document.getElementById("vitalSignList");
    if(list.children.length>=10){ 
      alert("Vital Sign List can have max 10 numbers!"); 
      const el=document.getElementById("num1"); 
      el.classList.add("vital-full"); 
      setTimeout(()=>el.classList.remove("vital-full"),800); 
      return;
    }
    if(!seriesByPrefix[prefix]) seriesByPrefix[prefix]=0; 
    seriesByPrefix[prefix]++;
    const newNum=format(prefix,seriesByPrefix[prefix]);
    document.getElementById("num1").textContent=newNum;
    addToVitalSignList(newNum);
    saveTableNumber(1,newNum);
    set(ref(db,"prefixSeries"),seriesByPrefix);
    highlightTable(1);
    return;
  }

  const nextNum=getNextAvailableNumber(prefix);
  if(!nextNum) return alert("No available number for "+prefix);
  const el=document.getElementById("num"+i); el.textContent=nextNum;
  usedNumbers.add(nextNum);
  table1DoneNumbers=table1DoneNumbers.filter(n=>n!==nextNum);
  saveTableNumber(i,nextNum);
  renderDoneList();
  document.getElementById("nextBtn"+i).disabled=true;
  highlightTable(i);
};

/* -------------------- Vital Sign List Functions -------------------- */
function renderVitalSignList(num) {
  const list = document.getElementById("vitalSignList"); 
  if(list.querySelector(`#vital-${num}`)) return; // avoid duplicates

  const div = document.createElement("div"); 
  div.className = "done-number"; 
  div.id = `vital-${num}`;
  const span = document.createElement("span"); 
  span.textContent = num;

  const checkBtn = document.createElement("button"); 
  checkBtn.textContent = "✅";
  checkBtn.style.width="50px"; 
  checkBtn.style.fontSize="20px"; 
  checkBtn.style.padding="0"; 
  checkBtn.style.background="#28a745"; 
  checkBtn.style.color="white"; 
  checkBtn.style.borderRadius="6px"; 
  checkBtn.style.border="none";

  checkBtn.onclick = () => {
    const current = document.getElementById("num1").textContent; 
    if(current === num){
      document.getElementById("num1").textContent="-"; 
      saveTableNumber(1,"-"); 
      highlightTable(1);
    }
    table1DoneNumbers.push(num); 
    renderDoneList(); 
    div.remove(); 
    highlightTable(1);
    remove(ref(db, "vitalSignList/" + num));
  };

  const xBtn = document.createElement("button"); 
  xBtn.textContent = "❌";
  xBtn.style.width="50px"; 
  xBtn.style.fontSize="20px"; 
  xBtn.style.padding="0"; 
  xBtn.style.background="#dc3545"; 
  xBtn.style.color="white"; 
  xBtn.style.borderRadius="6px"; 
  xBtn.style.border="none";

  xBtn.onclick = () => {
    push(ref(db,"owc"),{table:1,number:num,time:Date.now()}); 
    div.remove(); 
    const current = document.getElementById("num1").textContent; 
    if(current === num){
      document.getElementById("num1").textContent="0"; 
      saveTableNumber(1,"0");
    }
    remove(ref(db, "vitalSignList/" + num));
  };

  const buttonGroup = document.createElement("div"); 
  buttonGroup.style.display="flex"; 
  buttonGroup.style.gap="5px"; 
  buttonGroup.appendChild(checkBtn); 
  buttonGroup.appendChild(xBtn);

  div.appendChild(span); 
  div.appendChild(buttonGroup); 
  list.appendChild(div);
}

function addToVitalSignList(num) {
  renderVitalSignList(num);
  set(ref(db,"vitalSignList/"+num), {number: num, time: Date.now()});
}

onValue(ref(db,"vitalSignList"), snap => {
  document.getElementById("vitalSignList").innerHTML = "";
  if(!snap.exists()) return;
  Object.values(snap.val()).forEach(v => {
    renderVitalSignList(v.number);
  });
});

/* -------------------- Done List -------------------- */
function renderDoneList(){
  const box=document.getElementById("doneNumbersList"); box.innerHTML="";
  const usedInTables=new Set(); 
  for(let i=2;i<=TOTAL_TABLES;i++){ 
    const val=document.getElementById("num"+i).textContent; 
    if(val!=="0"&&val!=="-") usedInTables.add(val);
  }
  table1DoneNumbers.forEach(n=>{
    if(!usedInTables.has(n)){ 
      const div=document.createElement("div"); 
      div.className="done-number"; 
      div.textContent=n; 
      box.appendChild(div); 
    }
  });
}

/* -------------------- Done/OWC Tables 2-5 -------------------- */
window.doneQueue=function(i){ 
  document.getElementById("num"+i).textContent="-"; 
  saveTableNumber(i,"-"); 
  renderDoneList(); 
  document.getElementById("nextBtn"+i).disabled=false; 
  highlightTable(i); 
};
window.owcQueue=function(i){ 
  const el=document.getElementById("num"+i); 
  const num=el.textContent; 
  if(!num||num==="0"||num==="-") return; 
  push(ref(db,"owc"),{table:i,number:num,time:Date.now()}); 
  el.textContent="0"; 
};
window.recallQueue = function(i) {
  const parent = document.getElementById("tableBox" + i);
  parent.classList.add("pulse");
  setTimeout(() => parent.classList.remove("pulse"), 1000);

  const currentNum = document.getElementById("num" + i).textContent;
  if (!currentNum || currentNum === "0" || currentNum === "-") return;

  const area = i === 1 ? "Vital Sign Area" : "Consultation Area";

  const [prefix, numStr] = currentNum.split("-");
  const num = parseInt(numStr, 10);

  const utterance = new SpeechSynthesisUtterance(
    `Now recalling, ${prefix} number ${num}. Please proceed to ${area}, table ${i}.`
  );
  utterance.rate = 1;
  utterance.pitch = 1;
  window.speechSynthesis.speak(utterance);
};

/* -------------------- OWC List -------------------- */
onValue(ref(db,"owc"),snap=>{
  const list=document.getElementById("owcList"); list.innerHTML="";
  if(!snap.exists()) return;

  Object.entries(snap.val()).forEach(([key,v])=>{
    const div=document.createElement("div"); div.className="owc-item";
    const span=document.createElement("span"); span.textContent=`${v.number} (Table ${v.table})`;

    const tableSelect=document.createElement("select");
    tableSelect.style.padding="5px 8px"; tableSelect.style.borderRadius="6px"; tableSelect.style.border="1px solid #ccc"; tableSelect.style.fontWeight="600"; tableSelect.style.fontSize="14px";
    for(let i=1;i<=TOTAL_TABLES;i++){ 
      const opt=document.createElement("option"); 
      opt.value=i; 
      opt.textContent=`Table ${i}`; 
      tableSelect.appendChild(opt);
    }
    tableSelect.value=v.table;

    const restoreBtn=document.createElement("button"); 
    restoreBtn.textContent="✅"; 
    restoreBtn.style.width="40px"; 
    restoreBtn.style.height="35px"; 
    restoreBtn.style.fontSize="18px"; 
    restoreBtn.style.background="#28a745"; 
    restoreBtn.style.color="white"; 
    restoreBtn.style.border="none"; 
    restoreBtn.style.borderRadius="6px"; 
    restoreBtn.style.cursor="pointer";

    restoreBtn.onclick=()=>{
      const chosenTable=parseInt(tableSelect.value);
      const currentValue=document.getElementById("num"+chosenTable).textContent;
      if(currentValue!=="0"&&currentValue!=="-"){ alert(`Cannot restore to Table ${chosenTable}, it already has a number.`); return;}
      if(chosenTable===1){ addToVitalSignList(v.number); } 
      else { 
        const el=document.getElementById("num"+chosenTable); 
        el.textContent=v.number; 
        usedNumbers.add(v.number); 
        table1DoneNumbers=table1DoneNumbers.filter(n=>n!==v.number); 
        saveTableNumber(chosenTable,v.number); 
        renderDoneList(); 
        document.getElementById("nextBtn"+chosenTable).disabled=true; 
      }
      highlightTable(chosenTable);
      remove(ref(db,"owc/"+key));
    };

    div.appendChild(span); div.appendChild(tableSelect); div.appendChild(restoreBtn); list.appendChild(div);
  });

  list.scrollTop = list.scrollHeight;
});

/* -------------------- Settings -------------------- */
window.showSettings=()=>{document.getElementById("modalOverlay").style.display="flex";}
window.closeSettings=()=>{document.getElementById("modalOverlay").style.display="none";}
window.savePrefix=()=>{ 
  const p=document.getElementById("prefixInput").value.split(",").map(s=>s.trim()).filter(Boolean); 
  set(ref(db,"settings/prefixes"),p); 
}

/* -------------------- Reset -------------------- */
window.resetQueues=()=>{
  if(!confirm("Reset all queues & OWC?")) return;
  for(let i=1;i<=TOTAL_TABLES;i++){ 
    document.getElementById("num"+i).textContent="0"; 
    saveTableNumber(i,"0"); 
    document.getElementById("nextBtn"+i).disabled=i!==1; 
  }
  document.getElementById("vitalSignList").innerHTML="";
  table1DoneNumbers=[]; usedNumbers.clear(); seriesByPrefix={};
  remove(ref(db,"owc")); 
  remove(ref(db,"vitalSignList")); 
  set(ref(db,"prefixSeries"),{});
  renderDoneList();
};
</script>
</body>
</html>
