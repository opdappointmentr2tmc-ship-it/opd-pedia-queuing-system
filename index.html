<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pediatric Clinic Queueing System</title>
<style>
/* ====== THEME / BASE ====== */
:root {
  --bg: #f0f2f5;
  --primary: #007bff;
  --done: #6c757d;
  --owc: #ffc107;
  --recall: #17a2b8;
  --success: #28a745;
  --danger: #dc3545;
  --card-bg: #ffffff;
  --shadow: 0 8px 25px rgba(0,0,0,0.08);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: Segoe UI, Tahoma, sans-serif;
}

body {
  background: var(--bg);
  color: #222;
  padding: 20px;
  min-height: 100vh;
}

/* ===== HEADER ===== */
#headerBar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.4s ease;
  max-height: 200px;
  opacity: 1;
}

#headerBar.collapsed {
  max-height: 0;
  padding-top: 0;
  padding-bottom: 0;
  opacity: 0;
}

h1 {
  font-size: 1.4rem;
}

#settingsButton {
  padding: 12px 16px;
  border-radius: 10px;
  background: var(--primary);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

/* ===== LAYOUT ===== */
#tablesContainer {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  flex-wrap: wrap;
}

#tables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 20px;
  flex: 1;
}

#historyContainer,
#owcContainer {
  max-width: 100%;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#historyContainer {
  width: 280px;
}

#owcContainer {
  width: 320px;
}

/* ===== TABLE BOX ===== */
.table-box {
  background: var(--card-bg);
  padding: 18px;
  border-radius: 14px;
  box-shadow: var(--shadow);
  text-align: center;
  transition: all 0.25s ease;
}

.table-box.highlight {
  animation: highlightPulse 1s ease-in-out;
}

@keyframes highlightPulse {
  0% { box-shadow: 0 0 20px rgba(40,167,69,0.75); transform: scale(1); }
  50% { box-shadow: 0 0 40px rgba(40,167,69,0.9); transform: scale(1.03); }
  100% { box-shadow: 0 0 20px rgba(40,167,69,0.75); transform: scale(1); }
}

.table-box.pulse {
  animation: pulseRecall 1s ease-in-out;
}

@keyframes pulseRecall {
  0% { box-shadow: 0 0 20px rgba(23,162,184,0.8); transform: scale(1); }
  50% { box-shadow: 0 0 40px rgba(23,162,184,0.95); transform: scale(1.05); }
  100% { box-shadow: 0 0 20px rgba(23,162,184,0.8); transform: scale(1); }
}

.table-box.pulse-owc {
  animation: pulseOWCTable 0.8s ease-in-out;
}

@keyframes pulseOWCTable {
  0% { box-shadow: 0 0 8px rgba(220,53,69,0.8); transform: scale(1); }
  50% { box-shadow: 0 0 25px rgba(220,53,69,0.95); transform: scale(1.03); }
  100% { box-shadow: 0 0 8px rgba(220,53,69,0.8); transform: scale(1); }
}

.table-box.pulse-restore {
  animation: pulseRestore 0.8s ease-in-out;
}

@keyframes pulseRestore {
  0% { box-shadow: 0 0 8px rgba(255,193,7,0.8); transform: scale(1); }
  50% { box-shadow: 0 0 25px rgba(255,193,7,0.95); transform: scale(1.03); }
  100% { box-shadow: 0 0 8px rgba(255,193,7,0.8); transform: scale(1); }
}

/* ===== QUEUE NUMBER ===== */
.queue-number {
  font-size: 60px;
  font-weight: 900;
  background: #e7eaed;
  padding: 16px;
  border-radius: 12px;
  margin: 18px 0;
  word-break: break-word;
}

/* ===== BUTTONS ===== */
button.common {
  padding: 10px;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  color: #fff;
  cursor: pointer;
}

button.common:disabled {
  background: #ccc !important;
  color: #666 !important;
  cursor: not-allowed;
  opacity: 0.7;
  box-shadow: none;
  transform: none;
}

button.common:not(:disabled):hover {
  transform: scale(1.03);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.next-btn { background: var(--primary); }
.done-btn { background: var(--done); }
.owc-btn { background: var(--danger); color: #fff; }
.recall-btn { background: var(--recall); }
.small-btn { padding: 6px 10px; border-radius: 8px; font-weight: 700; }

/* ===== TABLE BUTTON STACK ===== */
.table-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 12px;
}

.table-buttons .common {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border-radius: 10px;
  font-weight: 800;
}

/* SETTINGS MODAL BUTTON STACK */
.settings-buttons {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  gap: 14px;
  margin-top: 22px;
}

.settings-buttons button {
  width: 92%;
  padding: 16px;
  font-size: 16px;
  font-weight: 800;
  border-radius: 12px;
  color: #fff !important;
}

#modalBox button:hover {
  opacity: 0.9;
}

/* ===== VITAL & DONE CONTAINERS ===== */
#vitalAndDone {
  display: flex;
  gap: 20px;
  margin-top: 24px;
  flex-wrap: wrap;
}

#vitalSignContainer, #doneContainer {
  flex: 1;
  min-width: 220px;
}

h2.section-title {
  font-size: 1.05rem;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

/* CARD STYLING FOR VITAL & DONE */
#vitalSignContainer .card,
#doneContainer .card {
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* INNER LISTS */
#vitalSignList, #doneNumbersList {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 12px;
  max-height: 500px;
  overflow-y: auto;
  display: grid;
  gap: 10px;
}

.done-number, .owc-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #dfe4e8;
  padding: 10px;
  border-radius: 8px;
  font-size: 18px;
  font-weight: 900;
  word-break: break-word;
}

.done-number > div:first-child {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 1;
  min-width: 0;
  overflow: hidden;
}

.done-number > div:first-child span.prefix-color {
  flex-shrink: 0;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 800;
  white-space: nowrap;
}

.done-number > div:first-child span:last-child {
  flex: 1 1 auto;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 60px;
}

.done-number > div:last-child {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

/* ===== COLLAPSIBLE PANEL ===== */
.collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.toggle-btn {
  background: transparent;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-weight: 700;
  padding: 6px;
  border-radius: 8px;
}

.toggle-btn .arrow {
  display: inline-block;
  transition: transform 0.28s ease;
}

.toggle-btn.collapsed .arrow {
  transform: rotate(-90deg);
}

.collapsible-content {
  overflow: hidden;
  max-height: 1200px;
  transition: max-height 0.36s ease, opacity 0.28s ease, padding-top 0.28s ease;
  padding-top: 10px;
}

.collapsible-content.collapsed {
  max-height: 0;
  padding-top: 0;
  opacity: 0;
}

/* ===== SELECTS & CONTROLS ===== */
.prefix-dropdown { width: 100%; padding: 8px; border-radius: 8px; margin-top: 10px; text-align: center; }
.controls-row { display: flex; gap: 8px; margin-top: 8px; }
.owc-list { display: flex; flex-direction: column; gap: 10px; max-height: 520px; overflow-y: auto; padding-right: 6px; }

/* ACTION BUTTONS INSIDE LISTS */
.list-action-btn { padding: 6px 8px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; }
.restore-select { padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-weight: 600; margin-right: 6px; }

/* ===== MODALS & OVERLAYS ===== */
#modalOverlay, #userMenuOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: none;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
}

#userMenuBox, #modalBox {
  background: #fff;
  padding: 22px;
  border-radius: 16px;
  width: 90%;
  max-width: 360px;
  text-align: center;
  box-shadow: var(--shadow);
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #333;
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  opacity: 0.95;
  z-index: 3000;
  font-size: 14px;
}

/* ===== HISTORY DONE LIST ===== */
#historyList {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 520px;
  overflow-y: auto;
  padding-right: 6px;
}

#historyList .owc-item {
  background: #f7f7f7;
  padding: 12px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 900;
  font-size: 16px;
  word-break: break-word;
}

/* ===== RESPONSIVE ===== */
@media(max-width: 900px) {
  .vital-list-grid, .done-list-grid { grid-template-columns: repeat(4,1fr); }
  #tablesContainer, #historyContainer, #owcContainer, #tables { width: 100%; flex-direction: column; }
}

@media(max-width: 700px) {
  .vital-list-grid, .done-list-grid { grid-template-columns: repeat(3,1fr); }
  .queue-number { font-size: 50px; }
}

@media(max-width: 500px) {
  .vital-list-grid, .done-list-grid { grid-template-columns: repeat(2,1fr); }
  .queue-number { font-size: 40px; padding: 10px; }
  button.common { font-size: 14px; padding: 10px; }
  h1, h2 { font-size: 1.1rem; }
}

@media(max-width: 400px) {
  .queue-number { font-size: 32px; padding: 8px; }
  button.common { font-size: 12px; padding: 8px; }
  h1, h2 { font-size: 1rem; }
}

/* ===== RIGHT PANEL - OWC ===== */
#owcContainer {
  width: 320px;
  max-width: 100%;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#owcContainer .card {
  background: var(--card-bg);
  padding: 14px;
  border-radius: 14px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.owc-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 520px;
  overflow-y: auto;
  padding-right: 6px; /* scrollbar spacing */
}

.owc-item {
  background: #f7f7f7;
  padding: 12px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 900;
  font-size: 16px;
  word-break: break-word;
}

/* Restore select & buttons inside OWC */
.restore-select {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-weight: 600;
  margin-right: 6px;
}

.list-action-btn {
  padding: 6px 8px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

/* ===== LEFT PANEL - History Done List ===== */
#historyContainer {
  width: 280px;
  max-width: 100%;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#historyContainer .card {
  background: var(--card-bg);
  padding: 14px;
  border-radius: 14px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#historyList {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 520px;
  overflow-y: auto;
  padding-right: 6px; /* scrollbar spacing */
}

#historyList .owc-item {
  background: #f7f7f7;
  padding: 12px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 900;
  font-size: 16px;
  word-break: break-word;
}
.prefix-color {
  flex-shrink: 0;         
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;        
  font-weight: 800;
  white-space: nowrap;     
  color: #fff; /* Ensure the text is visible on colored background */
}
/* ===== FIXED HEADER ===== */
/* Ensure header is at the very top */
#headerBar {
  margin-bottom: 20px; /* space below the header */
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
</style>
</head>
<body>
<!-- STARTUP USER MENU -->
<div id="userMenuOverlay">
  <div id="userMenuBox">
    <h2>Select Your Table</h2>
    <select id="tableSelectMenu" style="width:100%;padding:10px;margin-top:10px;border-radius:8px;font-size:16px">
      <option value="">-- Choose Table --</option>
      <option value="1">Table 1</option>
      <option value="2">Table 2</option>
      <option value="3">Table 3</option>
      <option value="4">Table 4</option>
      <option value="5">Table 5</option>
      <option value="all">Nurse Station (Show All Tables)</option>
    </select>
    <button class="small-btn" style="margin-top:14px;background:var(--primary);color:#fff;border:none;border-radius:8px;padding:10px 18px;font-weight:800" onclick="confirmTableSelection()">Continue</button>
  </div>
</div>

<!-- HEADER & SETTINGS BUTTON -->
<div id="headerBar">
  <h1>Pediatric Clinic Queueing System</h1>
  <button id="settingsButton" onclick="showSettings()">Settings ‚öôÔ∏è</button>
</div>

<!-- OPTIONAL HEADER TOGGLE BUTTON -->
<div style="margin-bottom:12px;">
  <button id="headerToggleBtn" class="small-btn" onclick="toggleHeader()" style="background:#17a2b8;color:#fff;display:flex;align-items:center;justify-content:center;">
    <span id="headerToggleIcon" style="display:inline-block;transition: transform 0.4s ease;">‚ñæ</span>
  </button>
</div>

<!-- MAIN CONTAINER -->
<div id="tablesContainer">

  <!-- LEFT PANEL: History Done -->
  <div id="historyContainer">
    <div class="card">
      <div class="collapsible-header">
        <h2 class="section-title">History Done List</h2>
        <button id="historyToggleBtn" class="toggle-btn" onclick="toggleHistory()" aria-expanded="true">
          <span class="arrow">‚ñæ</span>
          <span id="historyToggleLabel">Hide</span>
        </button>
      </div>
      <div id="historyContent" class="collapsible-content">
        <div id="historyList" class="owc-list"></div>
      </div>
    </div>
  </div>

  <!-- MAIN TABLES GRID -->
  <div id="tables"></div>

  <!-- RIGHT PANEL: OWC -->
  <div id="owcContainer">
    <div class="card">
      <div class="collapsible-header">
        <h2 class="section-title" style="margin:0;font-size:1rem">OUT WHEN CALLED</h2>
        <button id="owcToggleBtn" class="toggle-btn" onclick="toggleOWC()" aria-expanded="true" title="Toggle OWC list">
          <span class="arrow">‚ñæ</span>
          <span id="owcToggleLabel">Hide</span>
        </button>
      </div>
      <div id="owcContent" class="collapsible-content">
        <div id="owcList" class="owc-list"></div>
      </div>
    </div>
  </div>

</div>

<!-- VITAL SIGN & DONE NUMBERS -->
<div id="vitalAndDone">
  <div id="vitalSignContainer">
    <div class="card">
      <div class="collapsible-header">
        <h2 class="section-title" style="margin:0">Vital Sign List</h2>
        <button id="vitalToggleBtn" class="toggle-btn" onclick="toggleVital()" aria-expanded="true" title="Toggle Vital Sign list">
          <span class="arrow">‚ñæ</span>
          <span id="vitalToggleLabel">Hide</span>
        </button>
      </div>
      <div id="vitalContent" class="collapsible-content">
        <div id="vitalSignList" class="vital-list-grid" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div id="doneContainer" style="flex:1">
    <div class="card">
      <div class="collapsible-header">
        <h2 class="section-title" style="margin:0">Done Numbers</h2>
        <button id="doneToggleBtn" class="toggle-btn" onclick="toggleDone()" aria-expanded="true" title="Toggle Done list">
          <span class="arrow">‚ñæ</span>
          <span id="doneToggleLabel">Hide</span>
        </button>
      </div>
      <div id="doneContent" class="collapsible-content">
        <div id="doneNumbersList" class="done-list-grid" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="modalOverlay">
  <div id="modalBox">
    <h2>Settings</h2>
    <label style="display:block;margin-top:10px">Custom Prefixes (comma separated)</label>
    <input id="prefixInput" type="text" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc">
    <div class="settings-buttons">
      <button onclick="savePrefix()" style="background:var(--primary);">SAVE PREFIXES</button>
      <button onclick="resetQueues()" style="background:var(--danger);">RESET QUEUES & OWC</button>
      <button onclick="changeTable()" style="background:#17a2b8;">CHANGE TABLE</button>
      <button onclick="closeSettings()" style="background:var(--success);">CLOSE</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

  /* -------------------- CONFIG -------------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyDlGQraZ7m_cdzL2bCxWOb1A165gTwVRKQ",
    authDomain: "r2tmc-opd-pedia-qs.firebaseapp.com",
    projectId: "r2tmc-opd-pedia-qs",
    storageBucket: "r2tmc-opd-pedia-qs.appspot.com",
    messagingSenderId: "467931438036",
    appId: "1:467931438036:web:7a15d05ff4a159116e9441",
    databaseURL: "https://r2tmc-opd-pedia-qs-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* -------------------- STATE -------------------- */
  const TOTAL_TABLES = 6;
  const MAX_VITAL_SIGN = 10;
  let selectedTable = localStorage.getItem("selectedTable") || null;
  let prefixes = [];
  let seriesByPrefix = {};
  let table1DoneNumbers = [];
  let usedNumbers = new Set();

  /* -------------------- UTIL -------------------- */
  function toast(msg){
    const d = document.createElement("div");
    d.className = "toast";
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 3000);
  }
  function stringToColor(str){
    let hash=0;
    for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash); }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return "#" + ("00000".substring(0, 6 - c.length) + c);
  }

  /* -------------------- TABLE SELECTION UI -------------------- */
window.confirmTableSelection = function(){
  const chosen = document.getElementById("tableSelectMenu").value;
  if(!chosen){ toast("Please select a table."); return; }
  selectedTable = (chosen === "all") ? "all" : parseInt(chosen);
  localStorage.setItem("selectedTable", selectedTable);
  applyTablePermissions();

  // ‚úÖ Re-render Done Numbers list
  renderDoneList();

  document.getElementById("userMenuOverlay").style.display = "none";
};



// Safe page load initializer
window.addEventListener("load", () => {
  // Render tables first
  renderTables();
 renderDoneList();
  // Force table selection on each refresh
  let selectedTable = null;
  const overlay = document.getElementById("userMenuOverlay");
  overlay.style.display = "flex"; // always show overlay on load

  // Disable all NEXT buttons except Table 1 initially
  for (let i = 1; i <= TOTAL_TABLES; i++) {
    const nextBtn = document.getElementById("nextBtn" + i);
    if (nextBtn) nextBtn.disabled = i !== 1; // Table 1 always enabled
  }

  // Setup table selection buttons inside overlay
  const tableButtons = document.querySelectorAll(".table-button"); // adjust selector
  tableButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      selectedTable = btn.dataset.table; // assume button has data-table="1" etc.
      sessionStorage.setItem("selectedTable", selectedTable);

      // Apply permissions & hide overlay
      applyTablePermissions();
      overlay.style.display = "none";

      // Enable NEXT buttons for all tables except Table 1 (already enabled)
      for (let i = 2; i <= TOTAL_TABLES; i++) {
        const nextBtn = document.getElementById("nextBtn" + i);
        if (nextBtn) nextBtn.disabled = false;
      }

      // Initialize button states after selection
      for (let i = 1; i <= TOTAL_TABLES; i++) {
        updateTableButtons(i);
      }
    });
  });

  // Firebase listeners for table numbers
  for (let i = 1; i <= TOTAL_TABLES; i++) {
    const el = document.getElementById("num" + i);
    const nextBtn = document.getElementById("nextBtn" + i);

    onValue(ref(db, "tableNumbers/table" + i), snap => {
      const val = snap.exists() ? snap.val() : (i === 1 ? "0" : "-");
      el.textContent = val;

      if (i !== 1 && val !== "0" && val !== "-") usedNumbers.add(val);

      // Update button states dynamically
      updateTableButtons(i);
    });
  }

  // Firebase listener for prefixes
  onValue(ref(db, "settings/prefixes"), snap => {
    prefixes = snap.exists() ? snap.val() : [];
    document.getElementById("prefixInput").value = prefixes.join(",");
    for (let i = 1; i <= TOTAL_TABLES; i++) {
      const sel = document.getElementById("prefixSelect" + i);
      sel.innerHTML = "";
      prefixes.forEach(p => {
        const o = document.createElement("option");
        o.value = p;
        o.textContent = p;
        sel.appendChild(o);
      });
    }
  });
});


  /* -------------------- RENDER TABLES -------------------- */
  function renderTables(){
  let html = "";
  for(let i=1;i<=TOTAL_TABLES;i++){
    const tableName = (i === 6) ? "Nurse Station" : `Table ${i}`;
    html += `<div class="table-box" id="tableBox${i}">
      <h2 style="margin:0">${tableName}</h2>

      <select id="prefixSelect${i}" class="prefix-dropdown"></select>
      <div id="num${i}" class="queue-number">${i===1 ? "0" : "-"}</div>

      <div class="table-buttons">
        ${i !== 1 ? `<button id="doneBtn${i}" class="common done-btn" onclick="doneQueue(${i})">DONE</button>` : ""}
        <button id="nextBtn${i}" class="common next-btn" onclick="nextQueue(${i})" ${i !== 1 ? "" : ""}>NEXT</button>
        ${i !== 1 ? `<button class="common owc-btn" onclick="owcQueue(${i})">OWC</button>` : ""}
        ${i !== 1 ? `<button class="common recall-btn" onclick="recallQueue(${i})">RECALL</button>` : ""}
      </div>
    </div>`;
  }
  document.getElementById("tables").innerHTML = html;
}

  renderTables();

window.toggleHeader = function() {
  const header = document.getElementById("headerBar");
  const icon = document.getElementById("headerToggleIcon");

  if(header.classList.contains("collapsed")) {
    header.classList.remove("collapsed"); // show
    icon.style.transform = "rotate(0deg)";
  } else {
    header.classList.add("collapsed");    // hide
    icon.style.transform = "rotate(-90deg)"; // points sideways when hidden
  }
};


/* -------------------- APPLY TABLE PERMISSIONS -------------------- */
function applyTablePermissions() {
  const vitalContainer = document.getElementById("vitalSignContainer");
  const historyContainer = document.getElementById("historyContainer"); // <--- History Done
  for (let i = 1; i <= TOTAL_TABLES; i++) {
    const box = document.getElementById("tableBox" + i);
    if (selectedTable === "all" || i === selectedTable) box.style.display = "block";
    else box.style.display = "none";
  }

  // Vital Sign list only visible for Table 1 or all
  if (selectedTable === 1 || selectedTable === "all") {
    vitalContainer.style.display = "block";
  } else {
    vitalContainer.style.display = "none";
  }

  // History Done list only visible for Nurse Station (Table 6) or all
  if (selectedTable === 6 || selectedTable === "all") {
    historyContainer.style.display = "block";
  } else {
    historyContainer.style.display = "none";
  }
}



  /* -------------------- PREFIXES (Firebase) -------------------- */
  onValue(ref(db,"settings/prefixes"), snap=>{
    prefixes = snap.exists()? snap.val() : [];
    document.getElementById("prefixInput").value = prefixes.join(",");
    for(let i=1;i<=TOTAL_TABLES;i++){
      const sel = document.getElementById("prefixSelect"+i);
      sel.innerHTML = "";
      prefixes.forEach(p=>{
        const o = document.createElement("option");
        o.value = p;
        o.textContent = p;
        sel.appendChild(o);
      });
    }
  });
  onValue(ref(db,"prefixSeries"), snap=>{
    seriesByPrefix = snap.exists()? snap.val() : {};
  });

  /* -------------------- TABLE NUMBERS (Firebase) -------------------- */
  for(let i=1;i<=TOTAL_TABLES;i++){
    onValue(ref(db,"tableNumbers/table"+i), snap=>{
      if(snap.exists()){
        const val = snap.val();
        document.getElementById("num"+i).textContent = val;
        if(i!==1 && val!=="0" && val!=="-") usedNumbers.add(val);
      }
    });
  }

  /* -------------------- TABLE1 DONE NUMBERS (Firebase) -------------------- */
  onValue(ref(db,"table1DoneNumbers"), snap=>{
    table1DoneNumbers = snap.exists()? snap.val() : [];
    renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
  });

  /* -------------------- NEXT / DONE / OWC / RECALL LOGIC -------------------- */
  function sortTable1DoneNumbers(){
    table1DoneNumbers.sort((a,b)=>{
      const [pA,nA] = a.split("-");
      const [pB,nB] = b.split("-");
      if(pA !== pB) return prefixes.indexOf(pA) - prefixes.indexOf(pB);
      return parseInt(nA,10) - parseInt(nB,10);
    });
  }
  function getNextAvailableNumber(prefix){
    // Always take the first matching prefix in the sorted done list
    if(!table1DoneNumbers || table1DoneNumbers.length === 0) return null;
    return table1DoneNumbers.find(n => n.startsWith(prefix)) || null;
  }

  window.nextQueue = function(i){
  const prefix = document.getElementById("prefixSelect"+i).value;
  if(!prefix){ toast("Select a prefix"); return; }

  const nextBtn = document.getElementById("nextBtn"+i);

  if(i === 1){
    const list = document.getElementById("vitalSignList");
    if(list.children.length >= MAX_VITAL_SIGN){ toast("Vital Sign List max "+MAX_VITAL_SIGN+"!"); return; }
    if(!seriesByPrefix[prefix]) seriesByPrefix[prefix] = 0;
    seriesByPrefix[prefix]++;
    const newNum = `${prefix}-${String(seriesByPrefix[prefix]).padStart(3,"0")}`;
    document.getElementById("num1").textContent = newNum;
    addToVitalSignList(newNum);
    set(ref(db,"tableNumbers/table1"), newNum);
    set(ref(db,"prefixSeries"), seriesByPrefix);
    highlightTable(1);
    return;
  }

  const nextNum = getNextAvailableNumber(prefix);
  if(!nextNum){ toast("No available number for "+prefix); return; }

  const el = document.getElementById("num"+i);
  el.textContent = nextNum;
  usedNumbers.add(nextNum);
  table1DoneNumbers = table1DoneNumbers.filter(n => n !== nextNum);
  sortTable1DoneNumbers();
  set(ref(db,"tableNumbers/table"+i), nextNum);
  renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase

  // ‚úÖ Only disable NEXT until Done is pressed
  if(nextBtn) nextBtn.disabled = true;
updateTableButtons(i);
  highlightTable(i);
};

window.doneQueue = function(i){
  const el = document.getElementById("num"+i);
  const num = el.textContent;
  if(num && num !== "0" && num !== "-"){

    if(i === 1){
      table1DoneNumbers.push(num);
      sortTable1DoneNumbers();
      renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
    } else {
      // Push to historyDone
      push(ref(db,"historyDone"), {
        number: num,
        table: i,
        timestamp: Date.now()
      });
    }

  }
  el.textContent = "-";
  set(ref(db,"tableNumbers/table"+i), "-");

  const nextBtn = document.getElementById("nextBtn"+i);
  if(nextBtn) nextBtn.disabled = false;  // enable NEXT
  updateTableButtons(i);
  highlightTable(i);
};

window.owcQueue = function(i) {
  const el = document.getElementById("num" + i);
  const num = el.textContent;
  if (!num || num === "0" || num === "-") return;

  // Pulse red for OWC
  pulseTable(i, "red");

  // Push to Firebase OWC
  push(ref(db, "owc"), { table: i, number: num, time: Date.now() });

  // Clear the table number
  el.textContent = "-";

  const nextBtn = document.getElementById("nextBtn" + i);
  if (nextBtn) nextBtn.disabled = false;

  updateTableButtons(i);
};



  window.recallQueue = function(i){
  const el = document.getElementById("num"+i);
  const currentNum = el?.textContent;

  // ‚úÖ Prevent recall if number is 0, -, or empty
  if(!currentNum || currentNum === "0" || currentNum === "-") return;

  const tableBox = document.getElementById("tableBox"+i);
  if(!tableBox) return;

  // Visual pulse effect
  tableBox.classList.add("pulse");
  setTimeout(()=>tableBox.classList.remove("pulse"), 1000);

  // Log recall event to Firebase
  const recallRef = ref(db,"recallEvents");
  const newRecall = {table:i, number:currentNum, timestamp:Date.now()};
  push(recallRef, newRecall);
};

function updateTableButtons(i){
  const el = document.getElementById("num"+i);
  if(!el) return;

  const num = el.textContent;
  const recallBtn = document.querySelector(`#tableBox${i} .recall-btn`);
  const owcBtn = document.querySelector(`#tableBox${i} .owc-btn`);
  const nextBtn = document.getElementById("nextBtn"+i);

  if(num === "0" || num === "-" || !num){
    if(recallBtn) recallBtn.disabled = true;
    if(owcBtn) owcBtn.disabled = true;
  } else {
    if(recallBtn) recallBtn.disabled = false;
    if(owcBtn) owcBtn.disabled = false;
  }

  // NEXT button is only disabled for tables != 1 after taking a number
  if(i !== 1 && nextBtn){
    nextBtn.disabled = (num !== "0" && num !== "-");
  }
}

// Initialize buttons state for all tables
for(let i=1; i<=TOTAL_TABLES; i++){
  updateTableButtons(i);
}
for (let i = 1; i <= TOTAL_TABLES; i++) {
  onValue(ref(db, "tableNumbers/table" + i), snap => {
    const val = snap.exists() ? snap.val() : (i === 1 ? "0" : "-");
    document.getElementById("num" + i).textContent = val;
    updateTableButtons(i);
  });
}


  /* -------------------- VITAL SIGN LIST -------------------- */
  function renderVitalSignList(num){
    const list = document.getElementById("vitalSignList");
    if(list.querySelector(`#vital-${num}`)) return;

    const div = document.createElement("div");
    div.className = "done-number";
    div.id = `vital-${num}`;

    const prefix = num.split("-")[0];
    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.alignItems = "center";
    left.style.gap = "8px";
    const colorSpan = document.createElement("span");
    colorSpan.className = "prefix-color";
    colorSpan.style.background = stringToColor(prefix);
    colorSpan.textContent = prefix;
    const textSpan = document.createElement("span");
    textSpan.textContent = num.split("-")[1];

    left.appendChild(colorSpan);
    left.appendChild(textSpan);

    const buttonGroup = document.createElement("div");
    buttonGroup.style.display = "flex";
    buttonGroup.style.gap = "6px";
    buttonGroup.style.alignItems = "center";

    const checkBtn = document.createElement("button");
    checkBtn.className = "list-action-btn";
    checkBtn.style.background = "var(--success)";
    checkBtn.style.color = "#fff";
    checkBtn.textContent = "‚úÖ";
    checkBtn.title = "Mark as Done / Move to Done list";
    checkBtn.onclick = ()=>{
      // if number currently in num1, clear it
      if(document.getElementById("num1").textContent === num){
        document.getElementById("num1").textContent = "-";
        set(ref(db,"tableNumbers/table1"), "-");
        highlightTable(1);
      }
      table1DoneNumbers.push(num);
      sortTable1DoneNumbers();
      renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
      div.remove();
      remove(ref(db,"vitalSignList/"+num));
    };

    const xBtn = document.createElement("button");
    xBtn.className = "list-action-btn";
    xBtn.style.background = "var(--danger)";
    xBtn.style.color = "#fff";
    xBtn.textContent = "‚ùå";
    xBtn.title = "Move to OWC";
    xBtn.onclick = ()=>{
      push(ref(db,"owc"), {table:1, number:num, time:Date.now()});
      div.remove();
      if(document.getElementById("num1").textContent === num){
        document.getElementById("num1").textContent = "0";
        set(ref(db,"tableNumbers/table1"), "0");
      }
      remove(ref(db,"vitalSignList/"+num));
    };

const recallBtn = document.createElement("button");
recallBtn.className = "list-action-btn";
recallBtn.style.background = "var(--recall)";
recallBtn.style.color = "#fff";
recallBtn.textContent = "üîî"; // or "RECALL"
recallBtn.title = "Recall this number";
recallBtn.onclick = ()=>{
  // Visual pulse effect for Table 1
  const tableBox = document.getElementById("tableBox1");
  if(tableBox){
    tableBox.classList.add("pulse");
    setTimeout(()=>tableBox.classList.remove("pulse"),1000);
  }

  // Log recall event to Firebase
  const recallRef = ref(db,"recallEvents");
  const newRecall = {table:1, number:num, timestamp:Date.now()};
  push(recallRef, newRecall);

  toast(`Recalled ${num}`);
};

    buttonGroup.appendChild(checkBtn);
    buttonGroup.appendChild(xBtn);
buttonGroup.appendChild(recallBtn);

    div.appendChild(left);
    div.appendChild(buttonGroup);
    list.appendChild(div);
  }

  function addToVitalSignList(num){
    renderVitalSignList(num);
    set(ref(db,"vitalSignList/"+num), {number:num, time:Date.now()});
  }

  onValue(ref(db,"vitalSignList"), snap=>{
    const list = document.getElementById("vitalSignList");
    list.innerHTML = "";
    if(!snap.exists()) return;
    // ensure newest order by time or alphabetical? we use stored object values
    Object.values(snap.val()).forEach(v => renderVitalSignList(v.number));
  });

// Reactive selectedTable so that changing it rerenders done list
let _selectedTable = 1; // default
Object.defineProperty(window, "selectedTable", {
  get() {
    return _selectedTable;
  },
  set(value) {
    _selectedTable = value;
    renderDoneList(); // automatically rerender when selection changes
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
  }
});

function renderDoneList() {
  const box = document.getElementById("doneNumbersList");
  if (!box) return;
  box.innerHTML = ""; // Clear old list

  // Mapping of table numbers to names
  const tableNames = {
    1: "Table 1",
    2: "Table 2",
    3: "Table 3",
    4: "Table 4",
    5: "Table 5",
    6: "Nurse Station"
  };

  // Find numbers already used in tables 2..TOTAL_TABLES
  const usedInTables = new Set();
  for (let i = 2; i <= TOTAL_TABLES; i++) {
    const val = document.getElementById("num" + i)?.textContent;
    if (val !== "0" && val !== "-") usedInTables.add(val);
  }

  // Loop through done numbers
  table1DoneNumbers.forEach((n) => {
    if (!usedInTables.has(n)) {
      const div = document.createElement("div");
      div.className = "done-number";

      const left = document.createElement("div");
      left.textContent = n;

      const rightControls = document.createElement("div");
      rightControls.style.display = "flex";
      rightControls.style.gap = "6px";
      rightControls.style.alignItems = "center";

      // Only show dropdown + restore button for Nurse Station or "all"
      if (selectedTable === 6 || selectedTable === "all") {
       const tableSelect = document.createElement("select");
tableSelect.className = "restore-select";

// Add all tables to dropdown
for (const [id, name] of Object.entries(tableNames)) {
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = name;
  tableSelect.appendChild(opt);
}

// Default selected table
tableSelect.value = selectedTable === "all" ? 6 : selectedTable;


        const restoreBtn = document.createElement("button");
        restoreBtn.className = "list-action-btn";
        restoreBtn.style.background = "var(--success)";
        restoreBtn.style.color = "#fff";
        restoreBtn.textContent = "‚úÖ";
        restoreBtn.title = "Restore to selected table";

        restoreBtn.onclick = () => {
          const chosenTable = parseInt(tableSelect.value);
          const el = document.getElementById("num" + chosenTable);

      if (chosenTable === 1) {
    addToVitalSignList(n);
    set(ref(db, "tableNumbers/table1"), n);
    document.getElementById("num1").textContent = n;
    updateTableButtons(1);

    // ‚úÖ Remove from Done Numbers and refresh UI
    table1DoneNumbers = table1DoneNumbers.filter(x => x !== n);
    renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
}
 else{
            if (el.textContent !== "0" && el.textContent !== "-") {
              toast(`Cannot restore: Table ${chosenTable} already has ${el.textContent}`);
              return;
            }
            el.textContent = n;
            usedNumbers.add(n);
            table1DoneNumbers = table1DoneNumbers.filter(x => x !== n);
            sortTable1DoneNumbers();
            set(ref(db, "tableNumbers/table" + chosenTable), n);
            renderDoneList(); // refresh after restore
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
            const nextBtn = document.getElementById("nextBtn" + chosenTable);
            if (nextBtn) nextBtn.disabled = true;
            updateTableButtons(chosenTable);
          }

          pulseTable(chosenTable, "yellow");
          highlightTable(chosenTable);
        };

        rightControls.appendChild(tableSelect);
        rightControls.appendChild(restoreBtn);
      }

      div.appendChild(left);
      div.appendChild(rightControls);
      box.appendChild(div);
    }
  });
}




  /* -------------------- OWC LIST -------------------- */
  onValue(ref(db,"owc"), snap => {
  const list = document.getElementById("owcList");
  list.innerHTML = "";
  if (!snap.exists()) return;

  // Convert object to array
  const owcArray = Object.entries(snap.val());

  // Sort by prefix alphabetically, then numeric part numerically
  owcArray.sort((a, b) => {
    const [prefixA, numA] = a[1].number.split("-");
    const [prefixB, numB] = b[1].number.split("-");
    if (prefixA !== prefixB) return prefixA.localeCompare(prefixB);
    return parseInt(numA, 10) - parseInt(numB, 10);
  });

  owcArray.forEach(([key, v]) => {
    const div = document.createElement("div");
    div.className = "owc-item";

    const left = document.createElement("div");
    left.textContent = `${v.number} (Table ${v.table})`;

    const rightControls = document.createElement("div");
    rightControls.style.display = "flex";
    rightControls.style.gap = "6px";
    rightControls.style.alignItems = "center";

    const tableSelect = document.createElement("select");
    tableSelect.className = "restore-select";
  // In OWC restore select, include table 6
for (let i = 1; i <= TOTAL_TABLES; i++) {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = (i===6) ? "Nurse Station" : `Table ${i}`;
  tableSelect.appendChild(opt);
}

    tableSelect.value = v.table;

    const restoreBtn = document.createElement("button");
    restoreBtn.className = "list-action-btn";
    restoreBtn.style.background = "var(--success)";
    restoreBtn.style.color = "#fff";
    restoreBtn.textContent = "‚úÖ";
    restoreBtn.title = "Restore to selected table";
    restoreBtn.onclick = () => {
  const chosenTable = parseInt(tableSelect.value);
  const numToRestore = v.number;
  const tableBox = document.getElementById("tableBox" + chosenTable);

  if (chosenTable === 1) {
    const vitalList = document.getElementById("vitalSignList");
    if (vitalList.children.length >= MAX_VITAL_SIGN) {
      toast("Cannot restore: Vital Sign Area full");
      return;
    }
    addToVitalSignList(numToRestore);
    set(ref(db, "tableNumbers/table1"), numToRestore);
    document.getElementById("num1").textContent = numToRestore;
    updateTableButtons(1);
  } else {
    const el = document.getElementById("num" + chosenTable);
    const current = el.textContent;
    if (current !== "0" && current !== "-") {
      toast(`Cannot restore: Table ${chosenTable} already has ${current}`);
      return;
    }
    el.textContent = numToRestore;
    usedNumbers.add(numToRestore);
    table1DoneNumbers = table1DoneNumbers.filter(n => n !== numToRestore);
    sortTable1DoneNumbers();
    set(ref(db, "tableNumbers/table" + chosenTable), numToRestore);
    renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
    const nextBtn = document.getElementById("nextBtn" + chosenTable);
    if (nextBtn) nextBtn.disabled = true;
    updateTableButtons(chosenTable);
  }

  // ‚ú® Unified pulse
  pulseTable(chosenTable, "yellow");

  highlightTable(chosenTable);

  // Remove from OWC in Firebase
  remove(ref(db, "owc/" + key));
};


    rightControls.appendChild(tableSelect);
    rightControls.appendChild(restoreBtn);

    div.appendChild(left);
    div.appendChild(rightControls);
    list.appendChild(div);
  });
});


  /* -------------------- SETTINGS -------------------- */
  window.showSettings = ()=>{ document.getElementById("modalOverlay").style.display = "flex"; }
  window.closeSettings = ()=>{ document.getElementById("modalOverlay").style.display = "none"; }
  window.savePrefix = ()=>{ const p = document.getElementById("prefixInput").value.split(",").map(s=>s.trim()).filter(Boolean); set(ref(db,"settings/prefixes"), p); toast("Prefixes saved"); }
 window.resetQueues = async () => {
  if (!confirm("Reset all queues & OWC?")) return;

  for (let i = 1; i <= TOTAL_TABLES; i++) {
    document.getElementById("num" + i).textContent = "0";
    await set(ref(db, "tableNumbers/table" + i), "0");
    const nextBtn = document.getElementById("nextBtn" + i);
    if (nextBtn) nextBtn.disabled = (i !== 1);
  }

  document.getElementById("vitalSignList").innerHTML = "";

  // Clear local arrays
  table1DoneNumbers = [];
  usedNumbers.clear();
  seriesByPrefix = {};

  // Remove OWC
  await remove(ref(db, "owc"));

  // Remove Vital Sign List in Firebase
  await remove(ref(db, "vitalSignList"));

  // Remove History Done List
  await remove(ref(db, "historyDone"));

  // Reset prefix series
  await set(ref(db, "prefixSeries"), {});

  // Render Done Numbers again
  renderDoneList();
  saveDoneNumbersToFirebase(); // üîπ Save to Firebase
  toast("Queues reset");
};


  /* -------------------- UTILITIES -------------------- */
  function createButton(label, bgColor, onClick, width="40px", height="35px"){
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.style.width = width;
    btn.style.height = height;
    btn.style.background = bgColor;
    btn.style.color = "#fff";
    btn.style.borderRadius = "6px";
    btn.style.border = "none";
    btn.style.cursor = "pointer";
    btn.onclick = onClick;
    return btn;
  }
  function highlightTable(i){ const box = document.getElementById("tableBox"+i); if(!box) return; box.classList.add("highlight"); setTimeout(()=>box.classList.remove("highlight"), 1000); }
function pulseTable(i, type = "green") {
  const box = document.getElementById("tableBox" + i);
  if (!box) return;

  const classMap = {
    green: "highlight",
    red: "pulse-owc",
    yellow: "pulse-restore"
  };

  const cls = classMap[type] || "highlight";
  box.classList.add(cls);
  setTimeout(() => box.classList.remove(cls), 800);
}


  /* -------------------- COLLAPSIBLE TOGGLERS -------------------- */
  // we'll persist collapsed state in localStorage so UI remains consistent on reload
  const COLLAPSE_KEYS = {
    owc: "collapsed_owc",
    vital: "collapsed_vital",
    done: "collapsed_done"
  };

  function setCollapsedUI(key, collapsed){
    const map = {
      owc: {content: "owcContent", btn: "owcToggleBtn", label: "owcToggleLabel"},
      vital: {content: "vitalContent", btn: "vitalToggleBtn", label: "vitalToggleLabel"},
      done: {content: "doneContent", btn: "doneToggleBtn", label: "doneToggleLabel"}
    }[key];
    if(!map) return;
    const content = document.getElementById(map.content);
    const btn = document.getElementById(map.btn);
    const label = document.getElementById(map.label);
    if(collapsed){
      content.classList.add("collapsed");
      btn.classList.add("collapsed");
      btn.setAttribute("aria-expanded","false");
      label.textContent = "Show";
    } else {
      content.classList.remove("collapsed");
      btn.classList.remove("collapsed");
      btn.setAttribute("aria-expanded","true");
      label.textContent = "Hide";
    }
    localStorage.setItem(COLLAPSE_KEYS[key], collapsed ? "1" : "0");
  }

  window.toggleOWC = function(){
    const key = "owc";
    const cur = localStorage.getItem(COLLAPSE_KEYS[key]) === "1";
    setCollapsedUI(key, !cur);
  };
  window.toggleVital = function(){
    const key = "vital";
    const cur = localStorage.getItem(COLLAPSE_KEYS[key]) === "1";
    setCollapsedUI(key, !cur);
  };
window.toggleDone = function(){
  const key = "done";
  const cur = localStorage.getItem(COLLAPSE_KEYS[key]) === "1";
  setCollapsedUI(key, !cur);
};

// Initialize collapsible UI based on stored states
window.addEventListener("load", ()=>{
  Object.keys(COLLAPSE_KEYS).forEach(key=>{
    const collapsed = localStorage.getItem(COLLAPSE_KEYS[key]) === "1";
    setCollapsedUI(key, collapsed);
  });
});

  // initialize collapsible states on load
  (function initCollapsibles(){
    const defaultStates = { owc:false, vital:false, done:false }; // default to expanded
    Object.keys(defaultStates).forEach(k=>{
      const v = localStorage.getItem(COLLAPSE_KEYS[k]);
      const collapsed = v === null ? defaultStates[k] : (v === "1");
      setCollapsedUI(k, collapsed);
    });
  })();

onValue(ref(db, "tableNumbers/table6"), snap => {
  const val = snap.exists() ? snap.val() : "-";
  document.getElementById("num6").textContent = val;
  updateTableButtons(6);
});

window.toggleHistory = function(){
    const content = document.getElementById("historyContent");
    const btn = document.getElementById("historyToggleBtn");
    const label = document.getElementById("historyToggleLabel");
    const collapsed = content.classList.contains("collapsed");
    if(collapsed){
      content.classList.remove("collapsed");
      btn.classList.remove("collapsed");
      btn.setAttribute("aria-expanded","true");
      label.textContent = "Hide";
    } else {
      content.classList.add("collapsed");
      btn.classList.add("collapsed");
      btn.setAttribute("aria-expanded","false");
      label.textContent = "Show";
    }
  };

  // FIREBASE SYNC HISTORY DONE
 onValue(ref(db,"historyDone"), snap=>{
  const list = document.getElementById("historyList");
  list.innerHTML = "";
  if(!snap.exists()) return;

  const historyArray = Object.entries(snap.val());

  // Sort by prefix & number
  historyArray.sort((a,b)=>{
    const [pA,nA] = a[1].number.split("-");
    const [pB,nB] = b[1].number.split("-");
    if(pA !== pB) return pA.localeCompare(pB);
    return parseInt(nA,10)-parseInt(nB,10);
  });

  historyArray.forEach(([key, v])=>{
    const div = document.createElement("div");
    div.className = "owc-item";

    // LEFT: only show the number (remove Table info)
    const left = document.createElement("div");
    left.textContent = v.number;  // <-- removed "(from Table #)"

    const rightControls = document.createElement("div");
    rightControls.style.display = "flex";
    rightControls.style.gap = "6px";
    rightControls.style.alignItems = "center";

    const tableSelect = document.createElement("select");
    tableSelect.className = "restore-select";
    for(let i=1;i<=TOTAL_TABLES;i++){
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = (i===6) ? "Nurse Station" : `Table ${i}`;
      tableSelect.appendChild(opt);
    }
    tableSelect.value = v.table;

    const restoreBtn = document.createElement("button");
    restoreBtn.className = "list-action-btn";
    restoreBtn.style.background = "var(--success)";
    restoreBtn.style.color = "#fff";
    restoreBtn.textContent = "‚úÖ";
    restoreBtn.title = "Restore to selected table";
    restoreBtn.onclick = ()=>{
      const chosenTable = parseInt(tableSelect.value);
      const numToRestore = v.number;

      const el = document.getElementById("num"+chosenTable);
      if(chosenTable !== 1 && el.textContent !== "0" && el.textContent !== "-"){
        toast(`Table ${chosenTable} already has ${el.textContent}`);
        return;
      }

      if(chosenTable === 1){
        const vitalList = document.getElementById("vitalSignList");
        if(vitalList.children.length >= MAX_VITAL_SIGN){
          toast("Vital Sign Area full");
          return;
        }
        addToVitalSignList(numToRestore);
        set(ref(db,"tableNumbers/table1"), numToRestore);
        document.getElementById("num1").textContent = numToRestore;
      } else {
        el.textContent = numToRestore;
        set(ref(db,"tableNumbers/table"+chosenTable), numToRestore);
      }

      pulseTable(chosenTable,"yellow");
      highlightTable(chosenTable);

      remove(ref(db,"historyDone/"+key));
    };

    rightControls.appendChild(tableSelect);
    rightControls.appendChild(restoreBtn);

    div.appendChild(left);
    div.appendChild(rightControls);
    list.appendChild(div);
  });
});
window.changeTable = function() {
  document.getElementById("modalOverlay").style.display = "none"; // close settings modal
  document.getElementById("userMenuOverlay").style.display = "flex"; // show table selection
};
function saveDoneNumbersToFirebase() {
  set(ref(db, "table1DoneNumbers"), table1DoneNumbers);
}

  /* -------------------- END -------------------- */
</script>
</body>
</html>
