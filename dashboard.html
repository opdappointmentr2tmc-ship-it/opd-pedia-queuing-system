<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Queue Dashboard</title>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;font-family:Segoe UI,Tahoma,sans-serif;background:linear-gradient(135deg,#e6e8eb,#cfd3d6);}
#mainContainer{display:flex;height:100vh;width:100%;gap:10px;padding:20px;box-sizing:border-box;}
#tables-container{display:flex;flex-direction:column;flex:1;gap:10px;height:100%;}
.area-header{font-size:2em;font-weight:bold;background:rgba(245,245,245,0.6);backdrop-filter:blur(12px);border-radius:25px;padding:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.08);color:#333;}
.table-row{display:grid;gap:10px;flex:1;}
#vital-sign-row{grid-template-columns:1fr;flex:1;}
#consultation-row{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);flex:2;}
.table-box{background:rgba(245,245,245,0.5);backdrop-filter:blur(12px);border-radius:25px;text-align:center;display:flex;flex-direction:column;justify-content:center;transition:transform 0.2s,box-shadow 0.2s;width:100%;height:100%;}
.table-box.highlight{animation:highlightPulse 1s ease-in-out;}
@keyframes highlightPulse{0%{box-shadow:0 0 25px rgba(0,123,255,0.8);transform:scale(1);}50%{box-shadow:0 0 50px rgba(0,123,255,0.9);transform:scale(1.05);}100%{box-shadow:0 0 25px rgba(0,123,255,0.8);transform:scale(1);}}
.title{font-size:2em;margin-bottom:10px;}
.queue-number{font-weight:900;border-radius:20px;color:#fff;display:flex;justify-content:center;align-items:center;flex:1;word-break:break-word;transition:background 0.3s,color 0.3s,font-size 0.2s;}
#owcContainer{width:350px;max-width:25%;height:100%;background:rgba(245,245,245,0.5);backdrop-filter:blur(12px);border-radius:25px;padding:30px;box-shadow:0 8px 25px rgba(0,0,0,0.08);overflow-y:auto;}
#owcContainer h2{font-size:2em;margin-bottom:20px;color:#d9534f;text-align:center;}
#owcList{display:grid;grid-template-columns:1fr;gap:10px;}
.owc-item{font-size:1.6em;padding:12px;border-radius:15px;background:rgba(217,83,79,0.7);text-align:center;font-weight:bold;color:#fff;animation:pulse 1.5s infinite;}
@keyframes pulse{0%{box-shadow:0 0 10px rgba(217,83,79,0.7);}50%{box-shadow:0 0 25px rgba(217,83,79,0.7);}100%{box-shadow:0 0 10px rgba(217,83,79,0.7);} }
@media screen and (max-width:1200px){#mainContainer{flex-direction:column;align-items:center;}#owcContainer{width:90%;margin-top:20px;}}
</style>
</head>
<body>
<div id="mainContainer">
  <div id="tables-container">
    <div class="area-header">VITAL SIGN AREA</div>
    <div class="table-row" id="vital-sign-row"></div>
    <div class="area-header">CONSULTATION AREA</div>
    <div class="table-row" id="consultation-row"></div>
  </div>
  <div id="owcContainer">
    <h2>OWC LIST</h2>
    <div id="owcList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlGQraZ7m_cdzL2bCxWOb1A165gTwVRKQ",
  authDomain: "r2tmc-opd-pedia-qs.firebaseapp.com",
  projectId: "r2tmc-opd-pedia-qs",
  storageBucket: "r2tmc-opd-pedia-qs.firebasestorage.app",
  messagingSenderId: "467931438036",
  appId: "1:467931438036:web:7a15d05ff4a159116e9441",
  measurementId: "G-KKYGFRSTWB",
  databaseURL: "https://r2tmc-opd-pedia-qs-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const TOTAL_TABLES = 5;
const prefixColors = {"PR":"rgba(0,123,255,0.7)","PF":"rgba(40,167,69,0.7)","PP":"rgba(255,193,7,0.7)","PI":"rgba(23,162,184,0.7)"};

// Keep track of which numbers have already been announced
const announcedNumbers = {};

function renderTables(){
  const vitalRow = document.getElementById("vital-sign-row");
  const consultRow = document.getElementById("consultation-row");

  // Table 1
  const div1 = document.createElement('div'); div1.className='table-box';
  const title1 = document.createElement('div'); title1.className='title'; title1.textContent='Table 1'; div1.appendChild(title1);
  const num1 = document.createElement('div'); num1.id='num1'; num1.className='queue-number'; num1.textContent='0'; div1.appendChild(num1);
  vitalRow.appendChild(div1);

  // Tables 2 to TOTAL_TABLES
  for(let i=2;i<=TOTAL_TABLES;i++){
    const div = document.createElement('div'); div.className='table-box';
    const title = document.createElement('div'); title.className='title'; title.textContent=`Table ${i}`; div.appendChild(title);
    const numDiv = document.createElement('div'); numDiv.id=`num${i}`; numDiv.className='queue-number'; numDiv.textContent='0'; div.appendChild(numDiv);
    consultRow.appendChild(div);
  }

  for(let i=1;i<=TOTAL_TABLES;i++){
    const el = document.getElementById(`num${i}`);
    const box = el.parentElement;
    announcedNumbers[i] = el.textContent; // Initialize with current value

    // Listen for table number changes
    onValue(ref(db, `tableNumbers/table${i}`), snap=>{
      const val = snap.exists()?snap.val():"0";
      el.textContent = val;
      const prefix = val.split("-")[0];
      if(prefixColors[prefix]){ el.style.background=prefixColors[prefix]; el.style.color="#fff"; }
      else{ el.style.background="rgba(0,0,0,0.2)"; el.style.color="#fff"; }

      const len = val.length;
      el.style.fontSize=(i===1)?(len<=3?'8em':(len<=5?'6em':'5em')):(len<=3?'6em':(len<=5?'5em':'4em'));

      // Announce only if value changed and not "-" or "0" and hasn't been announced
      if(val !== "-" && val !== "0" && val !== announcedNumbers[i]){
        speakNumber(val, i, "Now serving");
        highlightTable(box);
        announcedNumbers[i] = val;
      }
    });

    // Listen for recall flags
    onValue(ref(db, `recall/table${i}`), snap=>{
      if(snap.exists()){
        const recallData = snap.val();
        const numberText = recallData.number;
        if(numberText){
          speakNumber(numberText, i, "Now recalling");
          highlightTable(box);
        }
        // Remove recall flag after speaking
        remove(ref(db, `recall/table${i}`));
      }
    });
  }
}
renderTables();

function speakNumber(numberText, tableNumber, action="Now serving"){
  if(!numberText || numberText==="0" || numberText==="-") return;
  const [prefix,numStr] = numberText.split("-");
  const number = parseInt(numStr,10);
  const area = tableNumber===1?"Vital Sign Area":"Consultation Area";
  const utterance = new SpeechSynthesisUtterance(`${action}, ${prefix} number ${number}. Please proceed to ${area}, table ${tableNumber}.`);
  utterance.rate=1;
  utterance.pitch=1;
  window.speechSynthesis.speak(utterance);
}

function highlightTable(box){
  box.classList.add('highlight');
  setTimeout(()=>{ box.classList.remove('highlight'); },1000);
}

// Live OWC
const owcList = document.getElementById("owcList");
onValue(ref(db, "owc"), snap=>{
  owcList.innerHTML='';
  if(!snap.exists()) return;
  Object.values(snap.val()).sort((a,b)=>a.time-b.time).forEach(e=>{
    const div=document.createElement("div"); div.className="owc-item"; div.textContent=`${e.number} (Table ${e.table})`;
    owcList.appendChild(div);
  });
});
</script>
</body>
</html>
