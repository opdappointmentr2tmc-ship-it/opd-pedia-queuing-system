<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pediatric Clinic Queue Dashboard</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background: linear-gradient(135deg,#e6e8eb,#cfd3d6);
    overflow: hidden; display: flex; flex-direction: column;
  }

/* --------- HEADER --------- */
#topHeader {
  background:#4CAF50;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:5px 10px; /* reduced padding */
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

#headerCenter {
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:2px 0;
}

#headerRow {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px; /* slightly smaller gap */
}

#headerTitle {
  font-size:2.5em; /* smaller title size */
  font-weight:900;
  text-align:center;
  text-shadow:2px 2px 6px rgba(0,0,0,0.25);
  white-space:nowrap;
}

#headerClock {
  font-size:2em; /* smaller clock size */
  font-weight:700;
  text-shadow:2px 2px 6px rgba(0,0,0,0.25);
  margin-top:3px;
}

#headerLogoLeft,
#headerLogoRight {
  height:80px; /* smaller logos */
  width:auto;
  object-fit:contain;
  filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
}

@media (max-width:900px){
  #headerRow { gap:6px; }
  #headerTitle { font-size:2em; }
  #headerLogoLeft, #headerLogoRight { height:60px; }
  #headerClock { font-size:1.8em; }
}
@media (max-width:600px){
  #headerRow { gap:5px; }
  #headerTitle { font-size:1.8em; }
  #headerLogoLeft, #headerLogoRight { height:50px; }
  #headerClock { font-size:1.4em; }
}
@media (max-width:500px){
  #headerRow { gap:4px; }
  #headerTitle { font-size:1.5em; }
  #headerLogoLeft, #headerLogoRight { height:40px; }
  #headerClock { font-size:1.2em; }
}
  /* --------- MAIN LAYOUT --------- */
  #mainContainer {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 10px 20px;
  flex: 1 1 auto;
  overflow: hidden;
}

#gridsContainer {
  display: flex;
  gap: 10px;
  flex: 1 1 auto; /* allow to shrink */
  overflow: hidden;
}

#leftPanel {
  flex: 1.5 1 0; /* allow shrinking */
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto; /* scroll if too tall */
}

#centerPanel {
  flex: 2 1 0; /* allow shrinking */
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto 1fr 1fr auto; /* last row for Table 6 (Nurse Station) */
  gap: 10px;
  overflow: hidden;
}


  .area-header { font-size:2em; font-weight:700; text-align:center; border-radius:25px; padding:15px; color:#fff; box-shadow:0 8px 25px rgba(0,0,0,0.08); }
.table-box {
  border-radius: 25px;
  display: flex;
  flex-direction: column;
  justify-content: center; /* center vertically */
  align-items: center;     /* center horizontally */
  padding: 10px;           /* enough padding */
  overflow: hidden;        /* only clip children if needed */
  background: #007bff;     /* or #28a745, your previous colors */
  color: #fff;
  min-height: 150px;       /* ensures box is big enough */
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}


  .title { font-size:2em; font-weight:700; margin-bottom:12px; text-align:center; }

  #table1Box { background:#007bff; color:#fff; }
  #num1List { display:grid; grid-template-columns:repeat(2,1fr); grid-auto-rows:minmax(80px,auto); gap:10px; width:100%; overflow-y:auto; }

  /* Vital Sign Table (Table 1) */
.queue-number {
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 900;
  border-radius: 20px;
  color: #fff;
  padding: 5px 10px;
  max-height: 100%;
  line-height: 1;
  text-align: center;
  overflow: hidden;
  white-space: nowrap;
  box-sizing: border-box;
  font-size: clamp(2rem, 8vw, 4rem); /* scales with screen width */
}
#centerPanel .table-box {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  min-height: 120px;
  max-height: 100%;
}
/* Consultation Tables (Tables 2-5) */
.queue-number-consult {
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 900;
  border-radius: 20px;
  color: #fff;
  padding: 5px 10px;
  max-height: 100%;
  line-height: 1;
  text-align: center;
  overflow: hidden;
  white-space: nowrap;
  box-sizing: border-box;
  font-size: clamp(3rem, 15vw, 8rem); /* scales with screen width */
}
  .queue-number.pulse, .queue-number-consult.pulse {
  animation: highlightPulse 1s ease-in-out;
}

@keyframes highlightPulse {
  0% { box-shadow: 0 0 35px rgba(0,123,255,0.8); transform:scale(1); }
  50% { box-shadow: 0 0 70px rgba(0,123,255,0.9); transform:scale(1.15); }
  100% { box-shadow: 0 0 35px rgba(0,123,255,0.8); transform:scale(1); }
}

/* OWC PANEL AT BOTTOM */
#owcContainer {
  background: rgba(245,245,245,0.55);
  backdrop-filter: blur(8px);
  border-radius: 25px;
  padding: 10px 20px 20px 20px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  transition: opacity 0.35s ease, max-height 0.4s ease, transform 0.35s ease;
  max-height: 0;      /* collapsed initially */
  opacity: 0;
  transform: translateY(-12px) scale(0.995);
  pointer-events: none;
  flex-shrink: 0;     /* ensures it takes space but doesnâ€™t shrink */
}

#owcContainer.visible {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
  max-height: 500px; /* adjust if more rows needed */
}

#owcContainer.hidden {
  opacity: 0;
  transform: translateY(-12px) scale(0.995);
  pointer-events: none;
  max-height: 0;
}

#owcContainer h2 {
  font-size: 2em;
  margin: 0 0 10px 0;
  color: #d9534f;
  text-align: center;
}

#owcList {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  align-items: start;
}

.owc-item {
  font-size: 1.6em;
  padding: 12px;
  border-radius: 15px;
  background: rgba(217,83,79,0.85);
  text-align: center;
  font-weight: 700;
  color: #fff;
  animation: pulse-red 1.5s infinite;
  opacity: 0;
  transform: translateY(8px);
}



/* Responsive adjustments */
@media (max-width:1200px){ 
  #owcList{grid-template-columns:repeat(3,1fr);} 
}
@media (max-width:700px){ 
  #owcList{grid-template-columns:repeat(2,1fr);} 
}
  @keyframes pulse { 0% { box-shadow:0 0 10px rgba(217,83,79,0.7);} 50% { box-shadow:0 0 25px rgba(217,83,79,0.7);} 100% { box-shadow:0 0 10px rgba(217,83,79,0.7);} }

  #startOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:1000; }
  #startOverlay button { padding:20px 40px; font-size:2em; border:none; border-radius:15px; background:#007bff; color:white; cursor:pointer; }

  @media (max-width:1200px){ #gridsContainer{flex-direction:column;} #centerPanel{grid-template-rows:auto auto auto;} #owcList{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:700px){ #owcList{grid-template-columns:repeat(2,1fr);} .queue-number-consult{font-size: clamp(3.2rem, 18vw, 6rem); } .queue-number{font-size: clamp(2rem, 8vw, 2.8rem); } }

#centerPanel .table-box {
  background: #28a745; /* keeps the green background */
  color: #fff;
  border-radius: 25px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  min-height: 150px; 
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.queue-number-consult {
  font-size: 5rem; /* number fits inside box */
  max-height: 100%; /* number stays inside box */
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}
#table6Box {
  grid-column: 1 / 3; /* span full width */
}
#mcContainer {
  background: rgba(245,245,245,0.55);
  backdrop-filter: blur(8px);
  border-radius: 25px;
  padding: 10px 20px 20px 20px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  transition: opacity 0.35s ease, max-height 0.4s ease, transform 0.35s ease;
  max-height: 0; /* collapsed initially */
  opacity: 0;
  transform: translateY(-12px) scale(0.995);
  pointer-events: none;
  margin-top: 10px;
}

#mcContainer.visible {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
  max-height: 500px; /* adjust if needed */
}

#mcContainer.hidden {
  opacity: 0;
  transform: translateY(-12px) scale(0.995);
  pointer-events: none;
  max-height: 0;
}

#mcContainer h2 {
  font-size: 2em;
  margin: 0 0 10px 0;
  color: #007bff; /* Changed to blue */
  text-align: center;
}

#mcList {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  align-items: start;
}
.mc-item {
  /* Copy styles from .owc-item but with blue background */
  font-size: 1.6em;
  padding: 12px;
  border-radius: 15px;
  background: #007bff; /* blue background instead of red */
  text-align: center;
  font-weight: 700;
  color: #fff;
   animation: pulse-blue 1.5s infinite;
  opacity: 0;
  transform: translateY(8px);
}
</style>
</head>
<body>

<!-- -------- HEADER -------- -->
<div id="topHeader">
  <div id="headerCenter">
    <div id="headerRow">
      <img id="headerLogoLeft" src="R2TMC_LOGO-removebg-preview.png" alt="Hospital Logo">
      <div id="headerTitle">PEDIATRIC CLINIC</div>
      <img id="headerLogoRight" src="dohlogo.png" alt="Hospital Logo">
    </div>
    <div id="headerClock">00:00:00</div>
  </div>
</div>

<div id="startOverlay">
  <button id="startBtn">Start Dashboard</button>
</div>

<!-- -------- MAIN DASHBOARD -------- -->
<div id="mainContainer" style="display:none; flex-direction: column;">
  <div id="gridsContainer">
    <div id="leftPanel">
      <div class="area-header" style="background:#007bff;">VITAL SIGN AREA</div>
      <div class="table-box" id="table1Box">
        <div class="title">Table 1</div>
        <div id="num1List"></div>
      </div>
    </div>

    <div id="centerPanel">
      <div class="area-header" style="grid-column:1/3;text-align:center;background:#28a745;">CONSULTATION AREA</div>
      
      <div class="table-box">
        <div class="title">Table 2</div>
        <div class="queue-number-consult" id="num2">0</div>
      </div>
      <div class="table-box">
        <div class="title">Table 3</div>
        <div class="queue-number-consult" id="num3">0</div>
      </div>
      
      <div class="table-box">
        <div class="title">Table 4</div>
        <div class="queue-number-consult" id="num4">0</div>
      </div>
      <div class="table-box">
        <div class="title">Table 5</div>
        <div class="queue-number-consult" id="num5">0</div>
      </div>

      <div class="table-box" id="table6Box" style="grid-column:1/3;">
        <div class="title">Nurse Station</div>
        <div class="queue-number-consult" id="num6">0</div>
      </div>
    </div>
  </div>

<!-- -------- Medical Certificate List -------- -->
<div id="mcContainer" class="hidden" style="flex-shrink:0;">
  <h2>MEDICAL CERTIFICATE</h2>
  <div id="mcList"></div>
</div>

  <!-- -------- OWC PANEL AT BOTTOM -------- -->
  <div id="owcContainer" class="hidden" style="flex-shrink:0;">
    <h2>OUT WHEN CALLED</h2>
    <div id="owcList"></div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDlGQraZ7m_cdzL2bCxWOb1A165gTwVRKQ",
  authDomain: "r2tmc-opd-pedia-qs.firebaseapp.com",
  projectId: "r2tmc-opd-pedia-qs",
  storageBucket: "r2tmc-opd-pedia-qs.appspot.com",
  messagingSenderId: "467931438036",
  appId: "1:467931438036:web:7a15d05ff4a159116e9441",
  measurementId: "G-KKYGFRSTWB",
  databaseURL: "https://r2tmc-opd-pedia-qs-default-rtdb.asia-southeast1.firebasedatabase.app"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let announcedMCIds = new Set(JSON.parse(localStorage.getItem('announcedMCIds') || '[]'));
/* ---------- LIVE CLOCK ---------- */
function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  document.getElementById("headerClock").textContent = timeStr;
}
setInterval(updateClock, 1000);
updateClock();

/* ---------- SPEECH SYSTEM ---------- */
let voices = [];
const preferredVoiceNames = ["Google US English","Google UK English Male","Google UK English Female"];
function loadVoices() { voices = window.speechSynthesis.getVoices().filter(v => preferredVoiceNames.includes(v.name)); }
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
function getRandomVoice() { if(!voices.length) return null; return voices[Math.floor(Math.random()*voices.length)]; }

const speechQueue = [];
let isSpeaking = false;
function speakQueuedNumber(num, table, action = "Now serving") {

  if (!num) return;

  // Add to queue
  speechQueue.push({ num, table, action });

  // If the queue was empty before adding, start processing immediately
  if (speechQueue.length === 1 && !isSpeaking) {
    processSpeechQueue();
  }
}

function processSpeechQueue() {
  if(speechQueue.length === 0) {
    isSpeaking = false;
    return;
  }

  isSpeaking = true;
  const { num, table, action } = speechQueue.shift();

  const [prefix, numStr] = (num || "").split("-");
let spokenPrefix;
if (prefix && prefix.toUpperCase() === "PP") {
  spokenPrefix = "PEDIA-PENADUR";
} else if (prefix && prefix.toUpperCase() === "PI") {
  spokenPrefix = "P I";
} else if (prefix && prefix.toUpperCase() === "OP") {
  spokenPrefix = "O P";
}
else {
  spokenPrefix = prefix;
}
  const number = parseInt(numStr || 0, 10) || numStr || num;

  // Determine area and table text
  let area = "";
  let tableText = "";
  if(table === 1) area = "Vital Sign Area";
  else if(table >= 2 && table <= 5) area = "Consultation Area";
  else if(table === 6) area = "Nurse Station";

  tableText = (table === 6) ? "" : `table ${table}`;

  const text = action 
    ? `${action}, ${spokenPrefix ? spokenPrefix + ' ' : ''}number ${number}. Please proceed to Pediatric Clinic Room 209 ${area} ${tableText}`.trim()
    : num;

  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = 1;
  utter.pitch = 1;
  if(voices.length) utter.voice = getRandomVoice();

  const beep = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=");
  beep.play().then(() => { window.speechSynthesis.speak(utter); }).catch(() => { window.speechSynthesis.speak(utter); });

  utter.onend = () => processSpeechQueue();
}

/* ---------- ANNOUNCE TRACKING ---------- */
let announcedTimestamps = JSON.parse(localStorage.getItem('announcedTimestamps')||'{}');
function shouldAnnounce(num,table){
  if(!num) return false;
  const key = `${table}_${num}`;
  const now = Date.now();
  if(!announcedTimestamps[key] || now - announcedTimestamps[key] > 15000){
    announcedTimestamps[key] = now;
    localStorage.setItem('announcedTimestamps',JSON.stringify(announcedTimestamps));
    return true;
  }
  return false;
}

/* ---------- DASHBOARD VARIABLES ---------- */
let vitalDisplayed = new Set(JSON.parse(localStorage.getItem('vitalDisplayed')||'[]'));
const tableColors = { 1:"#007bff",2:"#28a745",3:"#28a745",4:"#28a745",5:"#28a745", vip:"#ff9800" };
function updateVitalDisplayed(numbers){ numbers.forEach(n=>vitalDisplayed.add(n)); localStorage.setItem('vitalDisplayed',JSON.stringify([...vitalDisplayed])); }

/* ---------- VITAL SIGN TABLE 1 ---------- */
function loadVitalSignList() {
  const num1List = document.getElementById('num1List');
  
  onValue(ref(db, "vitalSignList"), snap => {
    if (!snap.exists()) { 
      num1List.innerHTML = ""; 
      return; 
    }

    const data = snap.val() || {};
    const entries = Object.entries(data)
      .filter(([_, e]) => e && e.number && e.number !== "-" && e.number.trim() !== "")
      .sort((a, b) => {
        const [pA, nA] = (a[1].number || "").split("-");
        const [pB, nB] = (b[1].number || "").split("-");
        if (pA === pB) return parseInt(nA || 0, 10) - parseInt(nB || 0, 10);
        return (pA || "").localeCompare(pB || "");
      })
      .slice(0, 10);

    // Remove all current DOM items
    num1List.innerHTML = "";

    entries.forEach(([key, e]) => {
      const number = e.number || "";
      const div = document.createElement("div");
      div.className = "queue-number";
      div.textContent = number;
      const [prefix] = number.split("-");
      div.style.background = prefix && prefix.toUpperCase() === "VIP" ? "#ff9800" : "#007bff";
      num1List.appendChild(div);

      // Animate and speak only if it hasn't been displayed
      if (!vitalDisplayed.has(number)) {
        vitalDisplayed.add(number); // add to memory
        speakQueuedNumber(number, 1, "Now serving");
        requestAnimationFrame(() => { div.classList.add("pulse"); setTimeout(() => div.classList.remove("pulse"), 1000); });
      }
    });

    // Clean localStorage: remove numbers no longer present
    const currentNumbers = entries.map(([_, e]) => e.number);
    vitalDisplayed = new Set(currentNumbers);
    localStorage.setItem('vitalDisplayed', JSON.stringify([...vitalDisplayed]));
  });
}

/* ---------- TABLES 2-5 ---------- */
function loadTables() {
  // Persisted memory: last valid numbers for Tables 2-6
  const lastValidNumbers = JSON.parse(localStorage.getItem('lastValidNumbers') || '{}');
  [2,3,4,5,6].forEach(i => { if (!lastValidNumbers[i]) lastValidNumbers[i] = ""; });

  // Track last announced numbers to avoid duplicate announcements
  const lastAnnounced = JSON.parse(localStorage.getItem('lastAnnounced') || '{}');
  [2,3,4,5,6].forEach(i => { if (!lastAnnounced[i]) lastAnnounced[i] = ""; });

  // Track currently shown numbers
  const lastShown = JSON.parse(localStorage.getItem('lastShownTables') || '{}');

  [2,3,4,5,6].forEach(i => {
    const numEl = document.getElementById(`num${i}`);
    const tableBox = document.getElementById(`table${i}Box`);
    if (!numEl) return;

    onValue(ref(db, `tableNumbers/table${i}`), snap => {
      let dbVal = snap.val();
      if (dbVal === null || dbVal === undefined) return;

      dbVal = String(dbVal).trim();

      // Always show current database value
      let displayValue = dbVal;

      // Update TableBox visibility (Table 6 always visible)
      if (tableBox) tableBox.style.display = "flex";

      // Announce only if value changed and is valid
if (displayValue && displayValue !== "-" && displayValue.trim() !== "") {
  speakQueuedNumber(displayValue, i, "Now serving");
  numEl.classList.add("pulse");
  setTimeout(() => numEl.classList.remove("pulse"), 1000);
  // Do not update lastAnnounced to always announce
}
      // Update visible text and styles
      numEl.textContent = displayValue;
      numEl.style.background = tableColors[i] || "#28a745";
      numEl.style.color = "#fff";

      // Save last shown state
      lastShown[i] = displayValue;
      localStorage.setItem('lastShownTables', JSON.stringify(lastShown));
    });
  });
}
function updateOWCVisibility() {
  return true; // Always allow OWC to show
}


function loadOWCList(){
  const owcContainer = document.getElementById('owcContainer');
  const owcList = document.getElementById('owcList');

  onValue(ref(db,"owc"), snap => {
    owcList.innerHTML = '';

    const canShow = updateOWCVisibility(); // check Table 6

    if(!snap.exists() || !canShow){ 
      owcContainer.classList.remove('visible');
      owcContainer.classList.add('hidden');
      owcContainer.style.maxHeight = "0px";
      return; 
    }

    const values = Object.values(snap.val() || {});
    const sorted = values.sort((a,b)=>{
      const [pA,nA] = (a.number||"").split("-");
      const [pB,nB] = (b.number||"").split("-");
      if(pA===pB) return parseInt(nA||0)-parseInt(nB||0);
      return (pA||"").localeCompare(pB||"");
    });

    sorted.forEach(e => {
      const div = document.createElement('div');
      div.className='owc-item';
      div.textContent = `${e.number}`;
      owcList.appendChild(div);

      requestAnimationFrame(()=>{ 
        div.style.transition="opacity .28s ease, transform .28s ease"; 
        div.style.opacity=1; 
        div.style.transform="translateY(0)"; 
      });
    });

    // Show OWC
    if(sorted.length > 0){
      owcContainer.classList.remove('hidden');
      owcContainer.classList.add('visible');
      requestAnimationFrame(()=>{ owcContainer.style.maxHeight = owcContainer.scrollHeight + "px"; });
    } else {
      owcContainer.classList.remove('visible');
      owcContainer.classList.add('hidden');
      owcContainer.style.maxHeight = "0px";
    }
  });
}



/* ---------- RECALL EVENTS ---------- */
onValue(ref(db,"recallEvents"), snap=>{
  if(!snap.exists()) return;
  const events=Object.values(snap.val());
  events.forEach(e=>{
    let numEl;
    if(e.table===1){ numEl = Array.from(document.querySelectorAll('#num1List .queue-number')).find(d=>d.textContent===e.number); }
    else numEl=document.getElementById('num'+e.table);
    if(numEl){ numEl.classList.add("pulse"); setTimeout(()=>numEl.classList.remove("pulse"),1000); }
    speakQueuedNumber(e.number,e.table,"Now recalling");
  });
  remove(ref(db,"recallEvents"));
});

/* ---------- START DASHBOARD ---------- */
document.getElementById('startBtn').addEventListener('click', ()=>{
  document.getElementById('startOverlay').style.display='none';
  document.getElementById('mainContainer').style.display='flex';
  // Existing calls
  speakQueuedNumber("Dashboard started",0,"");
  loadVitalSignList();
  loadTables();
  loadOWCList();

  // Add new call for Medical Certificate list
  loadMCList();
});

function fitNumber(el) {
  let fontSize = parseInt(window.getComputedStyle(el).fontSize);
  while (el.scrollWidth > el.clientWidth && fontSize > 10) {
    fontSize -= 1;
    el.style.fontSize = fontSize + "px";
  }
}
// Declare a Set outside the function to keep track of announced certificate numbers
let announcedCertificates = new Set(JSON.parse(localStorage.getItem('announcedCertificates') || '[]'));

function loadMCList() {
  const mcContainer = document.getElementById('mcContainer');
  const mcList = document.getElementById('mcList');

  onValue(ref(db, "mcList"), snap => {
    mcList.innerHTML = '';

    if (!snap.exists()) {
      mcContainer.classList.remove('visible');
      mcContainer.classList.add('hidden');
      mcContainer.style.maxHeight = "0px";
      return;
    }

    const items = Object.entries(snap.val() || {});
    // Sort by timestamp descending (latest first)
    items.sort((a, b) => b[1].timestamp - a[1].timestamp);

    // Now, sort by prefix alphabetically and then numerically
    items.sort((a, b) => {
      const [prefixA, numStrA] = (a[1].number || "").split("-");
      const [prefixB, numStrB] = (b[1].number || "").split("-");

      // Compare prefixes
      const prefixCompare = (prefixA || "").localeCompare(prefixB || "");
      if (prefixCompare !== 0) return prefixCompare;

      // If prefixes are same, compare numeric parts
      const numA = parseInt((numStrA || "0").replace(/^0+/, ""), 10);
      const numB = parseInt((numStrB || "0").replace(/^0+/, ""), 10);
      return numA - numB;
    });

    // Loop through sorted items
    items.forEach(([id, e]) => {
      const div = document.createElement('div');
      div.className='mc-item';
      div.textContent = e.number; // e.g., "PR-001"
      mcList.appendChild(div);

      // Animate appearance
      requestAnimationFrame(() => { 
        div.style.transition="opacity .28s ease, transform .28s ease"; 
        div.style.opacity=1; 
        div.style.transform="translateY(0)"; 
      });

      // Announce only if not announced before
      if (!announcedMCIds.has(id)) {
        announcedMCIds.add(id);
        localStorage.setItem('announcedMCIds', JSON.stringify(Array.from(announcedMCIds)));

        const [prefix, numStr] = (e.number || "").split("-");

        let spokenPrefix;
        if (prefix && prefix.toUpperCase() === "PP") {
          spokenPrefix = "PENADUR";
        } else if (prefix && prefix.toUpperCase() === "PI") {
          spokenPrefix = "P I";
        } else if (prefix && prefix.toUpperCase() === "OP") {
          spokenPrefix = "O P";
        } else {
          spokenPrefix = prefix || "";
        }

        const spokenNumber = (numStr || "").replace(/^0+/, "");
        const message = `Patient number ${spokenPrefix} ${spokenNumber}, please proceed to the Pediatric Clinic Room 209 - Nurse Station to claim your medical certificate.`;

        announceCustomMessage(message);
      }
    });

    // Show the container
    mcContainer.classList.remove('hidden');
    mcContainer.classList.add('visible');
    requestAnimationFrame(() => { mcContainer.style.maxHeight = mcContainer.scrollHeight + "px"; });

  });
}



// Implement the announceCustomMessage function
function announceCustomMessage(message) {
  const utter = new SpeechSynthesisUtterance(message);
  utter.rate = 1;
  utter.pitch = 1;
  if (voices.length) utter.voice = getRandomVoice();
  window.speechSynthesis.speak(utter);
}

</script>
</body>
</html>
